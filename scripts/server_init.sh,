#!/bin/bash

# --- [1/5] SYSTEM MAINTENANCE ---
sudo apt update -y > /dev/null 2>&1

# --- [2/5] DATA COLLECTION ---
# CPU (Gerçek anlık kullanım: 0.00 hatasını önlemek için top kullanıyoruz)
CPU_LOAD=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')

# Disk
DISK_TOTAL=$(df -BG / | grep / | awk '{print $2}' | sed 's/G//')
DISK_USED=$(df -BG / | grep / | awk '{print $3}' | sed 's/G//')
DISK_PCT=$(df / | grep / | awk '{print $5}' | sed 's/%//' | head -n 1)

# RAM (Format düzeltme: .5 yerine 0.5)
RAM_TOTAL_MB=$(free -m | grep Mem | awk '{print $2}')
RAM_USED_MB=$(free -m | grep Mem | awk '{print $3}')
RAM_PCT=$(( 100 * RAM_USED_MB / RAM_TOTAL_MB ))
RAM_TOTAL_GB=$(echo "scale=1; $RAM_TOTAL_MB/1024" | bc | awk '{printf "%.1f", $0}')
RAM_USED_GB=$(echo "scale=1; $RAM_USED_MB/1024" | bc | awk '{printf "%.1f", $0}')

# Health & Time
UPTIME_VAL=$(uptime -p | sed 's/up //')
UPTIME_RAW=$(uptime -s)
TIME=$(date "+%d.%m.%Y - %H:%M")
UPDATES=$(apt list --upgradable 2>/dev/null | grep -c upgradable)

# Services
NGINX=$(systemctl is-active nginx)
SSH=$(ss -tulpn | grep -q ":2222" && echo "OPEN" || echo "CLOSED")
UFW=$(sudo ufw status | grep -q "active" && echo "ACTIVE" || echo "INACTIVE")

# --- [3/5] HTML INJECTION (SED) ---
WEB_FILE="/home/burak/Junior-SysAdmin-Lab/index.html"

# System Health
sed -i "s/id=\"uptime-val\">[^<]*/id=\"uptime-val\">$UPTIME_VAL/g" $WEB_FILE
sed -i "s/id=\"cpu-val\"[^>]*>[^<]*/id=\"cpu-val\" style=\"color:var(--success)\">$CPU_LOAD/g" $WEB_FILE
sed -i "s/id=\"uptime-raw\">[^<]*/id=\"uptime-raw\">Since $UPTIME_RAW/g" $WEB_FILE

# Storage (Bar Fixed)
sed -i "s/id=\"disk-pct\">[^<]*/id=\"disk-pct\">$DISK_PCT%/g" $WEB_FILE
sed -i "s/id=\"disk-bar\" class=\"progress-fill\" style=\"width: [0-9]*%/id=\"disk-bar\" class=\"progress-fill\" style=\"width: $DISK_PCT%/g" $WEB_FILE
sed -i "s/id=\"disk-info\">[^<]*/id=\"disk-info\">$DISK_USED GB \/ $DISK_TOTAL GB/g" $WEB_FILE

# Memory (Fixed Percent & 0.x format)
sed -i "s/id=\"ram-pct\">[^<]*/id=\"ram-pct\">$RAM_PCT%/g" $WEB_FILE
sed -i "s/id=\"ram-bar\" class=\"progress-fill\" style=\"background:#a855f7; width: [0-9]*%/id=\"ram-bar\" class=\"progress-fill\" style=\"background:#a855f7; width: $RAM_PCT%/g" $WEB_FILE
sed -i "s/id=\"ram-info\">[^<]*/id=\"ram-info\">$RAM_USED_GB GB \/ $RAM_TOTAL_GB GB/g" $WEB_FILE

# Services
[[ "$NGINX" == "active" ]] && N_COL="var(--success)" || N_COL="var(--danger)"
sed -i "s/id=\"stat-nginx\"[^>]*>[^<]*/id=\"stat-nginx\" style=\"color:$N_COL\">${NGINX^^}/g" $WEB_FILE
[[ "$SSH" == "OPEN" ]] && S_COL="var(--success)" || S_COL="var(--danger)"
sed -i "s/id=\"stat-ssh\"[^>]*>[^<]*/id=\"stat-ssh\" style=\"color:$S_COL\">$SSH/g" $WEB_FILE
sed -i "s/id=\"stat-fw\"[^>]*>[^<]*/id=\"stat-fw\" style=\"color:var(--success)\">$UFW/g" $WEB_FILE
sed -i "s/id=\"pending-up\"[^>]*>[^<]*/id=\"pending-up\" style=\"color:var(--warn); font-weight:bold;\">$UPDATES/g" $WEB_FILE

# Log & Footer
sed -i "s/id=\"last-update\">[^<]*/id=\"last-update\">$TIME/g" $WEB_FILE
sed -i "s/id=\"log-time\">[^<]*/id=\"log-time\">$TIME/g" $WEB_FILE

# Code Monitor Log Injection
LOG_ENTRY="[$(date +%H:%M:%S)] DISK:$DISK_PCT% | RAM:$RAM_PCT% | CPU:$CPU_LOAD | Updated HTML successfully."
sed -i "/id=\"code-viewer\"/a $LOG_ENTRY" $WEB_FILE

echo "Dashboard updated at $TIME"
